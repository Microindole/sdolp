# 模块七详解 · 通用模型与工具 (Common & Utilities)

## 1. 模块概述

通用模型与工具模块是 MiniDB 项目的共享基础层。它不执行具体的数据库操作，而是为所有其他核心模块提供统一的**数据结构定义**、**自定义异常**以及一系列用于开发、调试和维护的**命令行工具**。

本模块的设计遵循了“高内聚、低耦合”和“Don't Repeat Yourself (DRY)”的原则。通过将这些基础组件集中管理，确保了整个项目在数据表示上的一致性，并极大地提高了代码的可复用性。

**核心职责**:

- **定义核心数据模型**: 提供如 `Tuple` (元组/行), `Schema` (模式), `Value` (值) 等标准的数据表示方式，让不同模块之间可以顺畅地传递数据。
- **定义自定义异常**: 创建专门的异常类型（如 `ParseException`, `SemanticException`），使错误处理更加精确和清晰。
- **提供辅助工具**: 开发独立的可执行工具，用于数据库的数据查看、备份导出以及事务日志的分析，极大地提升了开发和运维效率。

## 2. 模块构成

本模块主要由三个逻辑部分构成，分别位于不同的包路径下：

- **`common.model`**: 包含了所有核心的数据模型类。
- **`common.exception`**: 包含了项目自定义的异常类。
- **`cli.tool`**: 包含了一系列可以独立运行的命令行辅助工具。

## 3. 核心组件详解

### 3.1 通用数据模型 (`common.model`)

这是项目中被引用最广泛的部分，定义了数据库操作的基本数据单元。

- **`Tuple`**:
  - **职责**: 表示表中的一条**记录（行）**。
  - **实现**: 内部持有一个 `List<Value>` 来存储该行的所有字段值。它还包含一个 `RID` (Record ID)，用于标识这条元组在磁盘上的物理位置。`Tuple` 对象提供了 `toBytes()` 和 `fromBytes()` 方法，用于在内存对象和持久化字节数组之间进行序列化和反序列化。
- **`Schema`**:
  - **职责**: 描述一张表的**模式（结构）**。
  - **实现**: 内部持有一个 `List<Column>`，定义了表的列名、数据类型和顺序。`Schema` 是解释 `Tuple` 中字节数据的“说明书”，告诉系统如何正确地解析和操作一行数据。
- **`Value`**:
  - **职责**: 封装一个字段的**具体值**。
  - **实现**: 内部包含 `DataType` 枚举和 `Object` 类型的 `value`。这种设计使得 `Value` 对象可以表示 `INT`, `VARCHAR`, `DECIMAL` 等多种数据类型。它同样实现了精细的序列化/反序列化逻辑，能够根据不同的 `DataType` 正确地读写字节。
- **`Column` & `DataType`**:
  - **职责**: `Column` 定义了一个**列**的属性（名称和类型）。`DataType` 是一个枚举，列出了 MiniDB 支持的所有数据类型。
  - **实现**: 这是构成 `Schema` 的基本单位。
- **`RID` (Record ID)**:
  - **职责**: 表示一条记录在磁盘上的**物理地址**。
  - **实现**: 一个简单的记录类 (Record)，包含 `pageNum` (页号) 和 `slotIndex` (页内槽位号)。`RID` 是连接**逻辑查询**（如通过索引找到Key）和**物理数据**（通过地址读取整行Tuple）的关键桥梁。

### 3.2 辅助工具 (`cli.tool`)

这些是为开发者和管理员设计的强大命令行工具，可以独立于数据库服务器运行。

- **`DataReader` (数据读取与导出工具)**:
  - **职责**: 提供两种核心功能：
    1. **交互式数据查看**: 允许用户在控制台中选择一个数据库，然后以格式化的表格形式逐一查看其中所有表的数据。
    2. **数据库备份**: 能够将整个数据库（包括所有表的 `CREATE TABLE` 语句和 `INSERT INTO` 语句）导出为一个标准的 `.sql` 文件。
  - **实现**: 该工具直接使用 `DiskManager` 和 `Catalog` 来读取 `.db` 文件，绕过了查询执行引擎，实现了对物理数据的直接访问。这是进行数据恢复和迁移的关键功能。
- **`LogReader` (日志分析工具)**:
  - **职责**: 解析并以人类可读的形式展示数据库的**事务日志（WAL）文件** (`.log`)。
  - **实现**: 它能够读取二进制的日志文件，并根据 `LogRecord` 的格式反序列化出每一条日志记录的详细信息，包括 LSN、事务ID、日志类型以及操作前后的数据镜像。这是调试事务和恢复逻辑时不可或缺的工具。
- **`QueryResultFormatter` (结果格式化工具)**:
  - **职责**: 一个可重用的静态工具类，负责将 `Schema` 和 `List<Tuple>` 格式化成美观的、带边框的文本表格。
  - **实现**: 在 `DataReader` 和 `InteractiveShell` 中被广泛使用，确保了控制台输出的一致性和可读性。

### 3.3 自定义异常 (`common.exception`)

- **职责**: 提供比标准Java异常更具描述性的错误类型。
- **实现**:
  - `ParseException`: 在**语法分析**阶段，当SQL语句不符合语法规则时抛出。
  - `SemanticException`: 在**语义分析**阶段，当SQL语句在语法上正确但在逻辑上错误（如查询不存在的表）时抛出。

## 4. 与其他模块的交互

- **被所有模块依赖**: `common.model` 中定义的数据结构是整个系统的通用语言。从**编译器**创建AST，到**执行引擎**处理`TupleIterator`，再到**存储引擎**在 `Page` 中存取字节，以及**事务模块**在 `LogRecord` 中记录数据镜像，所有核心模块都在直接或间接地创建和操作这些核心模型对象。
- **与存储引擎和元数据模块的直接交互**: `cli.tool` 中的工具直接与 `DiskManager` 和 `Catalog` 交互，以读取底层的物理数据和元数据，这使得它们能够独立于运行中的数据库服务器进行工作。